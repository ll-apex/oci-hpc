# HPCクラスタでのOpenFoamプロジェクトの実行

## 概要

HPCハードウェアの設定およびアプリケーション・ソフトウェアの上位へのデプロイには時間がかかり、様々な複雑な操作が含まれます。このデモでは、これらのタスクはすべてOCIマーケットプレイス・イメージ内で自動化され、プロビジョニング直後にOpenFoamシミュレーション・ソフトウェアとともに完全に機能するHPC環境が提供されます。必要なのは、完全に機能するHPC環境でワークロードを実行し、Paraviewなどのビジュアライゼーション・アプリケーションを実行して出力をレンダリングすることです。

見積時間: 60分

### 参照アーキテクチャ

![](./images/29_Architecture.png " ")

### OpenFoamについて

計算流体力学(CFD)は数値解析による流体運動と熱伝達のシミュレーションである。OpenFOAMなどのCFDソフトウェアは、設計の改善、影響の視覚化、およびシステムの非効率性の検出を行う多くのエンジニアリング業界にとって強力なツールとして機能します。ただし、シミュレーションの処理に必要な計算能力は非常に集中的になります。スーパーコンピュータとHPCクラスタは、多くの場合、適切な時間枠内で大規模で複雑なモデルを実行するために使用されます。Oracle HPCクラスタ内でオープンソースのCFDソフトウェアOpenFOAMを使用して、オートバイの空力モデルを計算およびレンダリングします。

### インフラストラクチャの用語

1.  ワーカー・ノード: 計算シミュレーションまたはその他のエンジニアリング・ワークロードのワークロードを実行するための処理能力を提供するHPCコンピュート・インスタンス。このデモ・コンピュート・シェイプでは、BM.HPC2.36ノードがワーカー・ノードです。
    
2.  ヘッド・ノード: すべての計算ジョブをスケジュールしてワーカー・ノードで実行するために発行できるコンピュート・インスタンス。HeadノードとBastionノードは、同じマシンにすることができます。このデモでは、要塞ノードをプロビジョニングしています。
    
3.  GPUノード: 計算ワークロードの出力をレンダリングするためにGPUプロセッサを使用する特殊なコンピュート・インスタンス。このデモはGPUマシンをプロビジョニングしていません。
    
4.  要塞ノード: パブリックIPを持つコンピュート・インスタンスは、通常プライベート・ネットワークにあるワーカー・ノードに接続するエントリ・ポイントとして機能します。
    
5.  RoCEネットワーク: RDMA over Converged Ethernet (RoCE)は、Ethernetネットワークを介したリモート・ダイレクト・メモリー・アクセス(RDMA)を可能にするネットワーク・プロトコルです。
    

### 目的

1.  OCIマーケットプレイス・イメージを使用して、完全に機能するHPC環境をプロビジョニングします。
    
2.  OpenFoamという名前のCFDベースのシミュレーション・アプリケーションのデプロイメント
    
3.  Openfoamワークロードの実行
    
4.  Paraviewビジュアライゼーション・アプリケーションを使用して出力をレンダリングします。
    

### 前提条件

次のものにアクセスできることを確認します。

1.  次のポリシーを使用して、コンピュート・サービスにタグ・ネームスペースの管理を認可します:
    
    "サービスcompute\_managementによるテナンシでのタグ・ネームスペースの使用を許可します"
    
2.  ベア・メタル・シェイプBM.HPC2.36はこのデモでのみ許可されています。同じアベイラビリティ・ドメインに少なくとも2つのコンピュート・シェイプが必要です。
    
3.  要塞サーバー用のVMコンピュート・イメージ。HPCノードと同じ可用性ドメインに存在する必要はありません。
    
4.  プライベート・サブネットおよびパブリック・サブネットを持つ既存のVCNを作成または使用するには、ユーザー資格証明に割当て制限が必要です。
    
5.  マーケットプレイス・イメージ「CFD Ready Cluster」へのアクセスこのデモで使用されるマーケットプレイス・イメージのバージョンは(バージョン: 20200625)です。
    

## タスク1: マーケットプレイス・イメージの起動

1.  ユーザーがマーケットプレイス・イメージを起動する前に、シェイプBM.HPC2.36の2つ以上のHPCノードが使用可能な可用性ドメインを確認します。**「メニュー」**→**「ガバナンス」**→**「制限」**、**「割当ておよび使用状況」**に移動します
    
    ![](./images/01-Service_Limits.png " ")
    
2.  **「メニュー」**→**「マーケットプレイス」**→**「アプリケーション」**に移動します
    
    ![](./images/02-Marketplace.png " ")
    
3.  検索ボックスに「cfd」と入力します。
    
    ![](./images/03-Search_marketplace.png " ")
    
4.  イメージをクリックして選択し、**「スタックの起動」**ボタンをクリックします。右側のコンパートメントにいることを確認します。
    
    ![](./images/04-Launch_Stack.png " ")
    
5.  スタックが起動したら、詳細を入力して、HPCワーカー・ノード、要塞サーバー、ネットワーキング・コンポーネント、VCNサーバーなどのリソースを作成します。スタックでは、openMPIやopenFoamなどのパッケージをデプロイするための入力も求められます。
    
6.  スタックの名前を下に指定してください
    
    ![](./images/05-Create_Stack01.png " ")
    
7.  プロビジョニングに使用可能なHPCノードがある可用性ドメインを選択します。Bastionサーバーへの接続に必要なSSH公開キーを指定します。
    
    ![](./images/06-Create_Stack02.png " ")
    
8.  要塞サーバーをプロビジョニングする可用性ドメインを選択します。HPCノード上のアベイラビリティ・ドメインとは異なる場合があります。選択した要塞ホスト・シェイプを選択します。要塞サーバーにVNCサーバーをインストールし、後でVNC接続を行うために必要なパスワードを指定するには、チェック・ボックスを選択します。
    
    ![](./images/07-Create_Stack03.png " ")
    
9.  ワーカー・ノードの場合、選択されるオプションはBM.HPC2.36のみです。プロビジョニングを完了するには、最低2つのHPCコンピュート・シェイプが必要です。次の画面で2つ以上のコンピュート・ノードを選択します。すべてのオプションをデフォルトのままにできます。
    
    ![](./images/08-Create_Stack04.png " ")
    
10.  「ネットワーク・オプション」で、スタックで渡されるデフォルト値を使用して新しいVCNを作成します。このデモでは、このスタックを介して作成された新しいVCNを作成します。ただし、既存のVCNも使用できます。
    
    ![](./images/09-Create_Stack05.png " ")
    
11.  「ファイルシステム」セクションでは、NFSマウントを作成し、その上にglusterファイルシステムをインストールする次のオプションを使用します。
    
    ![](./images/10-Create_Stack06.png " ")
    
12.  このHPCスタックにOpenFoamアプリケーションをインストールするには、「INSTALL OPENFOAM」チェック・ボックスを選択します。
    
    ![](./images/11-Create_Stack07.png " ")
    
13.  スタックの最後のページで、入力された詳細を確認し、すべてに問題がない場合は「作成」ボタンをクリックして、インフラストラクチャおよびソフトウェアのインストールのプロビジョニングを開始します。
    
    ![](./images/12-Create_Stack08.png " ")
    
14.  HPCスタックのインストールの進捗の確認
    
    ![](./images/13-StackJob.png " ")
    
15.  プロビジョニングが約20分後に完了すると、ログ・ファイルに次のメッセージが表示されます。ログは、メニュー->リソース・マネージャ->スタック(スタック名をクリック) ->ジョブにあります(完全なログを表示するには、ジョブ名のリンクをクリックしてください)
    
    ![](./images/14-StackJobDetails.png " ")
    

## タスク2: 設定の検証

1.  画面左側の「リソースの関連付け」リンクをクリックして、このスタックによってプロビジョニングされたインフラストラクチャ・リソースを表示します。リソースの関連付けは、**「メニュー」** -> **「リソース・マネージャ」** -> **「スタック」**(スタック名をクリック) -> **「ジョブ」**(ジョブ名のリンクをクリック) -> **「リソースの関連付け」**にあります
    
    ![](./images/15-Stack_Resources.png " ")
    
2.  **「コンピュート」** -> **「インスタンス」**で、3つのコンピュート・インスタンスがプロビジョニングされ、プライベート・ネットワークで2つのHPCノードが、パブリックIPアドレスで1つのBastionサーバーがプロビジョニングされます。
    
    ![](./images/16-Compute_Details.png " ")
    
3.  公開キーが上のスタックにアップロードされたSSH秘密キーを使用して、opcユーザーとしてパブリックIPアドレスを使用してBastionサーバーに接続します。Linux/Macデスクトップから接続するには、この方法を使用します。Windowsデスクトップの場合は、Puttyを使用し、ppk秘密鍵を指定して接続します。
    
    ![](./images/17-Bastion_ssh.png " ")
    
4.  2つのHPCノードおよび要塞サーバーにマウントされている共有NFSストレージを確認します。このNFSストレージには、ワークロードの実行に使用されるOpenFoamソフトウェアが含まれています。
    
    ![](./images/18-Bastion_storage.png " ")
    
5.  OpenFoamアプリケーションは"/mnt/gluster-share/work"フォルダにホストされます。ワークロードが実行される2つのHPCノードのpriavte IPアドレスを含むhostfileを確認します。
    
    ![](./images/19-Bastion_openfoam.png " ")
    
6.  次の出力は、ポート5901で実行中のVNCサーバーを示しています。このポートは、要塞ホストへのVNC接続の作成に使用されます。
    
    ![](./images/20-Bastion_VNCdetails.png " ")
    
7.  ポート5901が許可されているイングレス・ルールの下にある要塞サーバーのセキュリティ・リストから確認してください。VNCが他のポートで実行されている場合、およびそのポートがセキュリティ・リスト内のイングレス・トラフィックに対して許可されていない場合は、同じものに対して新しいセキュリティ・ルールを作成します。
    
    ![](./images/21-SecList_OpenVNC_Port.png " ")
    
8.  HPCノードの名前を確認します。
    
    ![](./images/22-ListHPCNodes.png " ")
    

## タスク3: シミュレーション・ワークロードの実行および出力のレンダリング

1.  要塞サーバーで、Paraviewパッケージを使用して出力をレンダリングするために必要な次のコマンドを実行します。
    
        <copy>$ sudo yum install -y mesa-libGLU
        $ cd /mnt/gluster-share
        $ curl -d submit="Download" -d version="v4.4" -d type="binary" -d os="Linux" -d downloadFile="ParaView-4.4.0-Qt4-Linux-64bit.tar.gz" https://www.paraview.org/paraview-downloads/download.php >file.tar.gz
        $ tar -xf file.tar.gz</copy>
        
2.  要塞サーバーからいずれかのHPCノードに接続し、ワークロードを実行します
    
        <copy>$ ssh 172.16.1.2
        $ cd /mnt/gluster-share/work/
        $ ./Allrun 36</copy>
        
    
        ./Allrun 36
        Cleaning /mnt/gluster-share/work case
        Mesh Dimensions: (40 16 16)
        Cores:36: 6, 6, 1
        Running surfaceFeatures on /mnt/gluster-share/work
        Running blockMesh on /mnt/gluster-share/work
        Running decomposePar on /mnt/gluster-share/work
        Running snappyHexMesh
        Running patchsummary
        Running potentialFoam
        Running simpleFoam
        Running reconstructParMesh on /mnt/gluster-share/work
        Running reconstructPar on /mnt/gluster-share/work
        219.95
        [opc@inst-quqyz-accurate-swan work]$
        
3.  ワークロードが正常に完了したら、次のようにマシンでVNCクライアントを構成します。要塞サーバーおよびVNCポートのパブリックIPの指定
    
    ![](./images/24-VNC_Connection.png " ")
    
4.  オプション: VNCポート5901を開けない場合、またはセキュリティー上の理由によりこのポートのsshトンネルを作成する必要がある場合は、次のコマンドを使用し、セキュリティーリストでポートを開かずにポート5901でsshトンネルを作成します。
    
    端末ウィンドウから次のコマンドを使用して、ラップトップ/デスクトップからトンネルを作成します。ここで、ポート5901の通信はsshポート22で行われ、IPアドレス150.136.41.3は要塞サーバーのパブリックIPアドレスです。
    
        <copy>$ ssh -L 5901:localhost:5901 -i Dropbox/amar_priv_key -N -f -l opc 150.136.41.3</copy>
        
5.  前述のsshトンネル端末ウィンドウは閉じないでください。次に、VNCセッションを開始し、今回はIPアドレスのかわりにポート5901で"localhost"を使用します(このポートがサブネットのセキュリティ・リストでオープンされていない場合でも)。
    
    ![](./images/28-ssh_Tunnel.png " ")
    
6.  要塞サーバー内からParaviewアプリケーションを起動します
    
        <copy>cd /mnt/gluster-share/ParaView-4.4.0-Qt4-Linux-64bit/bin/
        ./paraview</copy>
        
7.  Paraviewアプリケーション・ウィンドウで、「ファイル」->「開く」->「パス」/mnt/gluster-share/workを選択し、ファイル名motorbike.foamを選択します。ゼロバイト・ファイルになるので問題ありません。
    
    ![](./images/25-Paraview_Menu.png " ")
    
8.  ウィンドウの左の「プロパティ」タブで、「メッシュ・リージョン」を選択してすべての値を選択し、motorBike\_接頭辞で始まらない最上位の値の選択を解除します。motorBike\_で始まるすべての値が選択されていることを確認します。「適用」ボタンをクリックすると、いくつかのエラーがポップアップし、ポップアップ表示されるエラー・ウィンドウを無視してVNCコンソールでイメージのレンダリングを表示します。
    
    ![](./images/26-Mesh_Regions.png " ")
    
9.  次のようなイメージが画面にレンダリングされます。表示設定によっては、画面上のイメージが少し異なる場合があります。
    
    ![](./images/27-Image_Rendering.png " ")
    

すべて完了!これで、HPCクラスタでOpenFoamアプリケーションを実行するためのデモが完了しました。

## 確認

*   **作成者** - High Performance Computeチーム
*   **貢献者** - Chris Iwicki、Harrison Dvoor、Gloria Lee、Selene Song、Bre Mendonca
*   **最終更新者/日付** - Harrison Dvoor、2021年1月